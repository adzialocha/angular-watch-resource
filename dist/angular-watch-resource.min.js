/*! angular-watch-resource.js v0.5.1 18-04-2014 */

!function(a,b,c){"use strict";var d=b.module("resource.service",[]);d.provider("ResourceConfiguration",[function(){var a={basePath:"",defaultData:{},defaultParams:{},defaultHeaders:{}},c={setBasePath:function(b){b&&"string"==typeof b&&(a.basePath=b)},setDefaultData:function(c){c&&b.isObject(c)&&(a.defaultData=c)},setDefaultParams:function(c){c&&b.isObject(c)&&(a.defaultParams=c)},setDefaultHeaders:function(c){c&&b.isObject(c)&&(a.defaultHeaders=c)},$get:function(){return{basePath:a.basePath,defaultData:a.defaultData,defaultParams:a.defaultParams,defaultHeaders:a.defaultHeaders}}};return c}]),d.factory("Resource",["$cacheFactory","$http","$q","$interval","ResourceConfiguration",function(a,d,e,f,g){var h="id",i=1,j=["GET","HEAD"],k=["PUT","POST","DELETE"],l="POST",m="id",n=[],o={},p=0,q=1,r=2,s=10,t=20,u=30,v=40,w={interval:0,silent:!1,sideload:{},nested:{},withCredentials:!1,responseType:"json",method:"GET",data:b.copy(g.defaultData),params:b.copy(g.defaultParams),headers:b.copy(g.defaultHeaders)},x=i,y={},z={},A={};A.unique=function(a){return a.filter(function(a,b,c){return c.indexOf(a)===b})},A.sort=function(a){return a.sort(function(a,b){return a-b})},A.hash=function(a){var b,c,d;if(b=0,d=a.length,0===d)return b;for(c=0;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;return b.toString()},A.update=function(a,c){var d=b.copy(a);return c&&b.forEach(Object.keys(c),function(a){a in d&&typeof d[a]==typeof c[a]&&(d[a]=b.isObject(d[a])?b.extend(d[a],c[a]):c[a])}),d},A.now=function(){var a=new Date;return a.getTime()},A.isEmpty=function(a){return a?b.isArray(a)?b.equals(n,a):b.equals(o,a):!0},A.pluck=function(a,c){var d=[];return b.forEach(a,function(a){c in a&&d.push(a[c])}),d},A.serialize=function(a){var c,d;return c=[],d="",b.forEach(Object.keys(a),function(d){a.hasOwnProperty(d)&&(b.isArray(a[d])?b.forEach(a[d],function(a){c.push(encodeURIComponent(d)+"[]="+a)}):c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d])))}),c.length>0&&(d="?"+c.join("&")),d};var B={};B.start=function(a,d){var e=this,g=a.$__meta.pointer.cacheKey,h=!1;if(!b.isNumber(d))throw"intervalUtils: interval frequency must be a number";return g in y?y[g].frequency!==d&&(this.stop(a),d>0&&(h=!0)):h=!0,h&&(y[g]={frequency:d,promise:c},y[g].promise=f(function(){a.fetch(null,function(){e.stop(a)},!0)},d),z.__intervals=y),h},B.stop=function(a){var b=a.$__meta.pointer.cacheKey;return b in y?(f.cancel(y[b].promise),delete y[b],z.__intervals=y,!0):!1};var C=function(b){z[b]={},this.name=b,this.storage=a(b)};C.prototype={exists:function(a){return b.isDefined(this.storage.get(a))},get:function(a){return this.storage.get(a)},set:function(a,b){return z[this.name][a]=b,this.storage.put(a,b)},update:function(a,b,c){if(!this.exists(a))return null;var d=this.get(a);return c||(d.$updatedTimestamp=A.now()),d.data=b,this.storage.put(a,d)},resetAll:function(){return z[this.name]={},this.storage.removeAll(),!0},reset:function(a){return delete z[this.name][a],this.storage.remove(a),!0}};var D=new C("__resourceCache"),E=new C("__atomicCache"),F={};F.resource={buildData:function(a,c){var d,e;return 0===c.length?!1:(a._data.type===q?(e=E.get(c[0]),d=e.data):(d=[],b.forEach(c,function(a){e=E.get(a),d.push(e.data)})),D.update(a.cacheKey,d),!0)}},F.atomic={_insertData:function(a,b){h in b||(b[h]="__internal"+x,x++);var c=(new H).build(a,b[h]);if(c.parseCacheKey(),!E.exists(c.cacheKey)){var d=new G(a,b[h]);E.set(c.cacheKey,d)}return E.update(c.cacheKey,b),c.cacheKey},_insertSideloadData:function(a,c){var d=this;b.forEach(Object.keys(a),function(e){e in c&&b.isArray(c[e])&&b.forEach(c[e],function(b){d._insertData(a[e],b)})})},cacheKeyArray:function(a,c){var d=[];return b.forEach(a,function(a){var b=(new H).build(c,a);b.parseCacheKey(),d.push(b.cacheKey)}),d},findUncached:function(a,b){return a.filter(function(a){var c=(new H).build(b,a);return c.parseCacheKey(),!E.exists(c.cacheKey)})},populateCache:function(a,c,d){var e=this,f=[];return b.isArray(d)?b.forEach(d,function(a){f.push(e._insertData(c,a))}):(f.push(this._insertData(c,d)),A.isEmpty(a.sideload)||this._insertSideloadData(a.sideload,d)),f}};var G=function(a,b){this.$createdTimestamp=A.now(),this.$updatedTimestamp=this.$createdTimestamp,this.$resourceName=a,this.$resourceId=b,this.data=o},H=function(a,b,d){this._path=a||"",this._vars=b||{},this._data=d||{type:q},this.cacheKey=c,this.resourcePath=""};H.prototype.isCollection=function(){return this._data.type===r},H.prototype.build=function(a,b){return this._path=a+"/:id",this._vars[h]=b,this},H.prototype.buildCollection=function(a,b){return this._path=a,this._data={type:r,collectionArray:b,collectionKey:m},this},H.prototype.parseCacheKey=function(){var a,b,c,d;if(a=this._path,a=a.replace(/\\:/g,":"),this._vars)for(b=Object.keys(this._vars),d=b.length,c=0;d>c;c++)a=a.replace(new RegExp(":"+b[c],"g"),this._vars[b[c]]);if("/"!==a[0]&&(a="/"+a),this.resourcePath=a,this.isCollection()){var e=A.hash(this._data.collectionArray.join("."));a=a+"?"+this._data.collectionKey+"="+e}return this.cacheKey=a,this},H.prototype.serializeUrl=function(a,c){var d,e;if(d=a,this.isCollection()){var f={};if(this._data.collectionKey in a)throw"ResourcePointerError: collection key already exists as parameter";f[this._data.collectionKey]=c?c:this._data.collectionArray,d=b.extend(f,a)}e=A.serialize(d);var h=g.basePath;return"/"===h[h.length-1]&&(h=h.slice(0,h.length-1)),h+this.resourcePath+e};var I={};I.build=function(a,b){return{method:b.method,url:a.serializeUrl(b.params),data:b.data,headers:b.headers,withCredentials:b.withCredentials,responseType:b.responseType,cache:!1}},I.optimize=function(a,b,c,d){var e={},f=!1,g=[];if(b._data.type===r){var i=F.atomic.findUncached(b._data.collectionArray,d);e.url=b.serializeUrl(c.params,i);var j=b._data.collectionArray.filter(function(a){return-1===i.indexOf(a)});g=F.atomic.cacheKeyArray(j,d),A.isEmpty(i)&&(f=!0)}else b._data.type===q?E.exists(b.cacheKey)&&(g=[b.cacheKey],f=!0):b._data.type===p&&D.get(b.cacheKey).isReady()&&(g=A.pluck(D.get(b.cacheKey).data,h),f=!0);var k=A.update(a,e);return{requestNotNeeded:f,cachedAtomicKeys:g,request:k}};var J=function(a,b,d){this.$__meta={pointer:a,options:d,errors:[],status:s},this.$createdTimestamp=A.now(),this.$updatedTimestamp=this.$createdTimestamp,this.$requestTimestamp=c,this.$resourceName=b,this.$url=a.serializeUrl(d.params),this.data=a._data.type===q?o:n};J.prototype={fetch:function(a,c,f,g){function h(a,b,c,h){var i;i=e.defer();var j,k,l,m,n;if(j=a,m=b,l=c,!f){if(k=I.optimize(j,l,m,h),n=k.cachedAtomicKeys,g||F.resource.buildData(l,n),k.requestNotNeeded)return i.resolve(!1),i.promise;j=k.request}return d(j).then(function(a){g||(n=F.atomic.populateCache(m,h,a.data),F.resource.buildData(l,n)),i.resolve(!0)},function(a){i.reject(a)}),i.promise}function i(a,d){a.$__meta.status=v,a.$__meta.errors.push(d.data),c&&b.isFunction(c)&&c(a)}function j(c,d){e.all(c).then(function(c){c&&(d.$requestTimestamp=A.now()),d.$__meta.status=u,a&&b.isFunction(a)&&a(d)},function(a){i(d,a)})}var k,l;k=this.$__meta.pointer,l=this.$__meta.options,this.isReady()||(this.$__meta.status=t);var m,n;if(m=I.build(k,l),n=[],n.push(h(m,l,k,this.$resourceName)),A.isEmpty(l.nested))j(n,this);else{var o=this;n[0].then(function(){n=[];var a=Object.keys(l.nested),c={};b.forEach(a,function(a){c[a]=[]});var d=[];d=b.isArray(o.data)?o.data:[o.data],b.forEach(d,function(d){b.forEach(a,function(a){var e=l.nested[a],f=d[e];b.isArray(f)||(f=[f]),c[a]=c[a].concat(f)})}),b.forEach(c,function(a,b){var c,d=A.sort(A.unique(a)),e=w;c=1===d.length?(new H).build(b,d[0]):(new H).buildCollection(b,d),c.parseCacheKey();var f=I.build(c,e);n.push(h(f,e,c,b))}),j(n,o)},function(a){i(o,a)})}return this},start:function(a){return B.start(this,a)},stop:function(){return B.stop(this)},isError:function(){return this.$__meta.status===v},isReady:function(){return this.$__meta.status===u},isEmpty:function(){return this.$__meta.status===u&&A.isEmpty(this.data)},message:function(a){var b=this.$__meta.errors;return 0===b.length?c:a?b:b[b.length-1]}};var K=function(a,d,f,g){var h,i,j,m,n;if(h=e.defer(),m=f,"method"in m||(m.method=l),m=A.update(w,m),-1===k.indexOf(m.method))throw"ResourceServiceError: method is not allowed";if(A.isEmpty(g)||!g.name||!g.id||!g.manipulate)throw"ResourceServiceError: resource manipulation info is missing";if(!b.isFunction(g.manipulate))throw"ResourceServiceError: manipulate property must be a function";var o=new H;if(o.build(g.name,g.id),o.parseCacheKey(),!A.isEmpty(g)&&E.exists(o.cacheKey)){var p=E.get(o.cacheKey).data;n=g.name,g.manipulate(p),E.update(o.cacheKey,p,!0)}return i=new H(a,d).parseCacheKey(),i.cacheKey=o.cacheKey,j=new J(i,n||c,m),j.fetch(function(){h.resolve(j)},function(){h.reject(j)},!0,n?!1:!0),h.promise},L=function(a,b,c,d,e){var f,g,h;if(g=e,g.type===r&&(g.collectionArray=A.sort(A.unique(g.collectionArray))),f=new H(a,b,g).parseCacheKey(),D.exists(f.cacheKey))h=D.get(f.cacheKey);else{var i=A.update(w,d);if(e.type!==q&&!A.isEmpty(d.sideload))throw"ResourceFactoryError: resources with array data cant handle sideloading";if(!A.isEmpty(d.sideload)&&!A.isEmpty(d.nested))throw"ResourceFactoryError: cant have a sideloading and nested option at the same time";if(-1===j.indexOf(i.method))throw"ResourceServiceError: method is not allowed";h=new J(f,c,i),D.set(f.cacheKey,h),i.silent||h.fetch(),i.interval>0&&B.start(h,i.interval)}return h},M=function(a,c){function d(){if(!a)throw"ResourceServiceError: path is missing";if(!b.isObject(g))throw"ResourceServiceError: path vars parameter must be an object"}function e(c,e,f){var h;if(d(),!c||"string"!=typeof c)throw"ResourceServiceError: resource name is missing or is not a string";if(h=e||{},!b.isObject(g))throw"ResourceServiceError: options parameter must be an object";return L(a,g,c,h,f)}function f(c,e){var f=c||{};if(d(),!b.isObject(g))throw"ResourceServiceError: options parameter must be an object";return K(a,g,f,e)}var g=c||{};return{all:function(a,b){return e(a,b,{type:p})},one:function(a,b){return e(a,b,{type:q})},collection:function(a,c,d,f){var g;if(!c||!b.isArray(c))throw"ResourceServiceError: collection parameter must be an array and not undefined";return g=d||m,e(a,f,{type:r,collectionKey:g,collectionArray:c})},send:function(a,b){return f(a,b)},reset:function(a,c){if(a){if(c){var d=c;return b.isArray(c)||(d=[c]),b.forEach(d,function(b){var c=(new H).build(a,b);c.parseCacheKey(),E.reset(c.cacheKey)}),!0}E.reset(a),D.reset(a)}else E.resetAll(),D.resetAll();return!0},debug:function(){return z}}};return M}])}(window,window.angular);
//# sourceMappingURL=angular-watch-resource.min.map