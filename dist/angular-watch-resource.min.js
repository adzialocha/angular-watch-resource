/*! angular-watch-resource.js 01-04-2014 */

!function(a,b,c){"use strict";function d(){var a=new Date;return a.getTime()}function e(a){var b,c,d;if(b=0,d=a.length,0===d)return b;for(c=0;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;return b.toString()}function f(a){var c,d;return c=[],d="",b.forEach(Object.keys(a),function(d){a.hasOwnProperty(d)&&(b.isArray(a[d])?b.forEach(a[d],function(a){c.push(encodeURIComponent(d)+"[]="+a)}):c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d])))}),c.length>0&&(d="?"+c.join("&")),d}function g(a){return a.filter(function(a,b,c){return c.indexOf(a)===b})}var h=b.module("ngWatchResource",[]);h.provider("ResourceConfiguration",[function(){var a={basePath:"",defaultData:{},defaultParams:{},defaultHeaders:{}},c={setBasePath:function(b){b&&"string"==typeof b&&(a.basePath=b)},setDefaultData:function(c){c&&b.isObject(c)&&(a.defaultData=c)},setDefaultParams:function(c){c&&b.isObject(c)&&(a.defaultParams=c)},setDefaultHeaders:function(c){c&&b.isObject(c)&&(a.defaultHeaders=c)},$get:function(){return{basePath:a.basePath,defaultData:a.defaultData,defaultParams:a.defaultParams,defaultHeaders:a.defaultHeaders}}};return c}]),h.factory("Resource",["$cacheFactory","$http","$q","$interval","ResourceConfiguration",function(a,h,i,j,k){function l(a,b){this.url=a,this.values=b,this.cache={key:null,collectionKey:null,collection:[],resourceName:c,resourceId:c}}function m(a,b,c){var e=this;this.__promise=i.defer(),this.__options=b,this.__interval=null,this.__cache=c,this._createdTimestamp=d(),this._updatedTimestamp=this._createdTimestamp,this._type=b.isArray?"array":"object",this.data=b.isArray?[]:{},this.ready=!1,this.error=null,0!==b.interval&&(this.__interval=j(function(){e.fetch(!0)},b.interval))}function n(a,c,d){var f={isArray:!1,withCredentials:!1,responseType:"json",method:"GET",interval:0,data:b.copy(k.defaultData),params:b.copy(k.defaultParams),headers:b.copy(k.defaultHeaders)};d&&"object"==typeof d&&b.forEach(Object.keys(d),function(a){a in f&&typeof f[a]==typeof d[a]&&(f[a]=b.isObject(f[a])?b.extend(f[a],d[a]):d[a])});var g,h,i,j=new l(a,c);if(h=k.basePath+j.build(),j.cache.key)if(j.cache.collectionKey){var n=j.cache.collection.sort();g=e(n.join(".")),f.params[j.cache.collectionKey]=n,f.isArray=!0}else g=j.cache.key;else g=e(h);return f.url=h,o.get(g)?i=o.get(g):(i=new m(g,f,j.cache),o.put(g,i),i.fetch()),i}var o=a("resourceCache"),p={optimizeCollection:function(a){var c,d={cached:[],remote:[]};return b.forEach(a.collection,function(b){c=a.resourceName+"/"+b,o.get(c)&&o.get(c).ready?d.cached.push(o.get(c).data):d.remote.push(b)}),d},populate:function(a,c){var d,e,f;return b.forEach(c,function(b){"id"in b&&(d=a.resourceName+"/"+b.id,f=new l(d,null),e=new m(d,{},f.cache),e.setReady(b),o.put(d,e))}),!0}};return l.prototype.build=function(){var a,c,d,e;if(a=this,e=this.url.match(/\{([^\}]+)\}/)){if(this.cache.collectionKey=e[1].replace(":",""),!(this.cache.collectionKey in this.values&&b.isArray(this.values[this.cache.collectionKey])))throw"ngWatchResource Error: collection key given but does not point to an array";this.cache.collection=g(this.values[this.cache.collectionKey])}if(c=this.url.replace(/\\:/g,":"),c=c.replace(/\{([^\}]+)\}/,""),this.values&&b.forEach(Object.keys(this.values),function(b){c=c.replace(new RegExp(":"+b,"g"),a.values[b])}),d=c.match(/\[([^\]]+)\]/g),d&&d.length>0){this.cache.key=d.join("/").replace(/[\[\]]/g,"");var f=this.cache.key.split("/");this.cache.resourceName=f[0],d.length>1&&(this.cache.resourceId=parseInt(f[1],10))}if(!d&&this.cache.collectionKey)throw"ngWatchResource Error: collection key but no resouce name given";return c=c.replace(/[\[\]]/g,"")},m.prototype={promise:function(){return this.__promise.promise},stopInterval:function(){return j.cancel(this.__interval),!0},fetch:function(a){var b,c,e=this;if(this.__promise=i.defer(),b=this.__options.params,c=!1,!a&&this.__cache.collectionKey&&this.__cache.collection.length>0){var g=p.optimizeCollection(this.__cache);if(b=this.__options.params,b[this.__cache.collectionKey]=g.remote,this.data=g.cached,0===g.remote.length)return this.__promise.resolve(this),!0;c=!0}var j={method:this.__options.method,url:this.__options.url+f(b),data:this.__options.data,headers:this.__options.headers,withCredentials:this.__options.withCredentials,responseType:this.__options.responseType,cache:!1};h(j).success(function(a){e.setReady(a,!0,c),o.put(e.__cache.key,e),e._updatedTimestamp=d(),e.__cache.resourceName&&"array"===e._type&&p.populate(e.__cache,a),e.__promise.resolve(e)}).error(function(a){e.setError(a),e.__promise.reject(e)})},setReady:function(a,c,d){return this.data=d&&b.isArray(this.data)?this.data.concat(a):a,this.error=null,this.ready=c||!0,this.ready},setError:function(a){return this.error=a,this.ready=!1,!0},set:function(a,b){return this._updatedTimestamp=d(),this.data[a]=b,!0},get:function(a){return this.data[a]},isEmpty:function(){return"array"===this._type&&this.ready?0===this.data.length:"object"===this._type&&this.ready?0===Object.keys(this.data).length:!1}},n}])}(window,window.angular);
//# sourceMappingURL=angular-watch-resource.min.map