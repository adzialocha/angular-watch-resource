/*! angular-watch-resource.js 04-04-2014 */

!function(a,b,c){"use strict";var d=b.module("ngWatchResource",[]);d.provider("ResourceConfiguration",[function(){var a={basePath:"",defaultData:{},defaultParams:{},defaultHeaders:{}},c={setBasePath:function(b){b&&"string"==typeof b&&(a.basePath=b)},setDefaultData:function(c){c&&b.isObject(c)&&(a.defaultData=c)},setDefaultParams:function(c){c&&b.isObject(c)&&(a.defaultParams=c)},setDefaultHeaders:function(c){c&&b.isObject(c)&&(a.defaultHeaders=c)},$get:function(){return{basePath:a.basePath,defaultData:a.defaultData,defaultParams:a.defaultParams,defaultHeaders:a.defaultHeaders}}};return c}]),d.factory("Resource",["$cacheFactory","$http","$q","$interval","ResourceConfiguration",function(a,d,e,f,g){var h="id",i=1,j="GET",k="id",l=[],m={},n=0,o=1,p=2,q=10,r=20,s=30,t=40,u={interval:0,silent:!1,sideload:{},withCredentials:!1,responseType:"json",data:b.copy(g.defaultData),params:b.copy(g.defaultParams),headers:b.copy(g.defaultHeaders)},v=i,w={},x={},y={};y.unique=function(a){return a.filter(function(a,b,c){return c.indexOf(a)===b})},y.hash=function(a){var b,c,d;if(b=0,d=a.length,0===d)return b;for(c=0;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;return b.toString()},y.update=function(a,c){var d=b.copy(a);return c&&b.forEach(Object.keys(c),function(a){a in d&&typeof d[a]==typeof c[a]&&(d[a]=b.isObject(d[a])?b.extend(d[a],c[a]):c[a])}),d},y.now=function(){var a=new Date;return a.getTime()},y.isEmpty=function(a){return a?b.isArray(a)?b.equals(l,a):b.equals(m,a):!0},y.pluck=function(a,c){var d=[];return b.forEach(a,function(a){c in a&&d.push(a[c])}),d},y.serialize=function(a){var c,d;return c=[],d="",b.forEach(Object.keys(a),function(d){a.hasOwnProperty(d)&&(b.isArray(a[d])?b.forEach(a[d],function(a){c.push(encodeURIComponent(d)+"[]="+a)}):c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d])))}),c.length>0&&(d="?"+c.join("&")),d};var z={};z.start=function(a,d){var e=this,g=a.$__meta.pointer.cacheKey,h=!1;if(!b.isNumber(d))throw"IntervalUtils: interval frequency must be a number";return g in w?w[g].frequency!==d&&(this.stop(a),d>0&&(h=!0)):h=!0,h&&(w[g]={frequency:d,promise:c},w[g].promise=f(function(){a.fetch(null,function(){e.stop(a)},!0)},d),x.__intervals=w),h},z.stop=function(a){var b=a.$__meta.pointer.cacheKey;return b in w?(f.cancel(w[b].promise),delete w[b],x.__intervals=w,!0):!1};var A=function(b){x[b]={},this.name=b,this.storage=a(b)};A.prototype={exists:function(a){return b.isDefined(this.storage.get(a))},get:function(a){return this.storage.get(a)},set:function(a,b){return x[this.name][a]=b,this.storage.put(a,b)},update:function(a,b){var c=this.get(a);return c.$updatedTimestamp=y.now(),c.data=b,this.storage.put(a,c)}};var B=new A("__resourceCache"),C=new A("__atomicCache"),D={};D.Resource={buildData:function(a,c){var d;return 0===c.length?!1:(a._data.type===o?d=C.get(c[0]).data:(d=[],b.forEach(c,function(a){d.push(C.get(a).data)})),B.update(a.cacheKey,d),!0)}},D.Atomic={_insertData:function(a,b){h in b||(b[h]="__internal"+v,v++);var c=(new F).build(a,b[h]);if(c.parseCacheKey(),!C.exists(c.cacheKey)){var d=new E(a,b[h]);C.set(c.cacheKey,d)}return C.update(c.cacheKey,b),c.cacheKey},_insertSideloadData:function(a,c){var d=this;b.forEach(Object.keys(a),function(e){e in c&&b.isArray(c[e])&&b.forEach(c[e],function(b){d._insertData(a[e],b)})})},cacheKeyArray:function(a,c){var d=[];return b.forEach(a,function(a){var b=(new F).build(c,a);d.push(b.parseCacheKey())}),d},findUncached:function(a,b){return a.filter(function(a){var c=(new F).build(b,a);return c.parseCacheKey(),!C.exists(c.cacheKey)})},populateCache:function(a,c,d){var e=this,f=[];return b.isArray(d)?b.forEach(d,function(a){f.push(e._insertData(c,a))}):(f.push(this._insertData(c,d)),y.isEmpty(a.sideload)||this._insertSideloadData(a.sideload,d)),f}};var E=function(a,b){this.$createdTimestamp=y.now(),this.$updatedTimestamp=this.$createdTimestamp,this.$resourceName=a,this.$resourceId=b,this.data=m},F=function(a,b,d){this._path=a||"",this._vars=b||{},this._data=d||{type:o},this.cacheKey=c,this.resourcePath=""};F.prototype.isCollection=function(){return this._data.type===p},F.prototype.build=function(a,b){return this._path=a+"/:id",this._vars[h]=b,this},F.prototype.parseCacheKey=function(){var a,b,c,d;if(a=this._path,a=a.replace(/\\:/g,":"),this._vars)for(b=Object.keys(this._vars),d=b.length,c=0;d>c;c++)a=a.replace(new RegExp(":"+b[c],"g"),this._vars[b[c]]);if("/"!==a[0]&&(a="/"+a),this.resourcePath=a,this.isCollection()){var e=y.hash(this._data.collectionArray.join("."));a=a+"?"+this._data.collectionKey+"="+e}return this.cacheKey=a,this},F.prototype.serializeUrl=function(a,c){var d,e;if(d=a,this.isCollection()){var f={};if(this._data.collectionKey in a)throw"ResourcePointerError: collection key already exists as parameter";f[this._data.collectionKey]=c?c:this._data.collectionArray,d=b.extend(f,a)}e=y.serialize(d);var h=g.basePath;return"/"===h[h.length-1]&&(h=h.slice(0,h.length-1)),h+this.resourcePath+e};var G={};G.build=function(a,b){var c=a.serializeUrl(b.params),d={method:j,url:c,data:b.data,headers:b.headers,withCredentials:b.withCredentials,responseType:b.responseType,cache:!1};return d},G.optimize=function(a,b,c,d){var e={},f=!1,g=[];if(b._data.type===p){var i=D.Atomic.findUncached(b._data.collectionArray,d);e.url=b.serializeUrl(c.params,i);var j=b._data.collectionArray.filter(function(a){return-1===i.indexOf(a)});g=D.Atomic.cacheKeyArray(j,d),y.isEmpty(i)&&(f=!0)}else b._data.type===o?C.exists(b.cacheKey)&&(g=[b.cacheKey],f=!0):b._data.type===n&&B.get(b.cacheKey).isReady()&&(g=y.pluck(B.get(b.cacheKey).data,h),f=!0);var k=y.update(a,e);return{requestNotNeeded:f,cachedAtomicKeys:g,request:k}};var H=function(a,b,d){this.$__meta={pointer:a,options:d,errors:[],status:q},this.$createdTimestamp=y.now(),this.$updatedTimestamp=this.$createdTimestamp,this.$requestTimestamp=c,this.$resourceName=b,this.$url=a.serializeUrl(d.params),this.data=a._data.type===o?m:l};H.prototype={fetch:function(a,c,e){var f,g,h,i,j=this;if(f=this.$__meta.pointer,g=this.$__meta.options,i=G.build(f,g),!e){var k=G.optimize(i,f,g,this.$resourceName);if(h=k.cachedAtomicKeys,D.Resource.buildData(f,h),k.requestNotNeeded)return this.$__meta.status=s,a&&b.isFunction(a)&&a(this),this;i=k.request}return this.isReady()||(this.$__meta.status=r),d(i).then(function(c){h=D.Atomic.populateCache(g,j.$resourceName,c.data),D.Resource.buildData(f,h),j.$requestTimestamp=y.now(),j.$__meta.status=s,a&&b.isFunction(a)&&a(j)},function(a){j.$__meta.status=t,j.$__meta.errors.push(a.data),c&&b.isFunction(c)&&c(j)}),this},start:function(a){return z.start(this,a)},stop:function(){return z.stop(this)},isError:function(){return this.$__meta.status===t},isReady:function(){return this.$__meta.status===s},isEmpty:function(){return this.$__meta.status===s&&y.isEmpty(this.data)},message:function(a){var b=this.$__meta.errors;return 0===b.length?c:a?b:b[b.length-1]}};var I=function(a,b,c,d,e){var f,g,h;if(g=e,g.type===p&&(g.collectionArray=y.unique(g.collectionArray).sort()),f=new F(a,b,g).parseCacheKey(),B.exists(f.cacheKey))h=B.get(f.cacheKey);else{var i=y.update(u,d);if(e.type!==o&&!y.isEmpty(d.sideload))throw"ResourceFactoryError: resources with array data cant handle sideloading";h=new H(f,c,i),B.set(f.cacheKey,h),i.silent||h.fetch(!1),i.interval>0&&z.start(h,i.interval)}return h},J=function(a,c){function d(c,d,f){var g;if(!a)throw"ResourceServiceError: path is missing";if(!b.isObject(e))throw"ResourceServiceError: path vars parameter must be an object";if(!c||"string"!=typeof c)throw"ResourceServiceError: resource name is missing or is not a string";if(g=d||{},!b.isObject(e))throw"ResourceServiceError: options parameter must be an object";return I(a,e,c,g,f)}var e=c||{};return{all:function(a,b){return d(a,b,{type:n})},one:function(a,b){return d(a,b,{type:o})},collection:function(a,c,e,f){var g;if(!c||!b.isArray(c))throw"ResourceServiceError: collection parameter must be an array and not undefined";return g=e||k,d(a,f,{type:p,collectionKey:g,collectionArray:c})},manipulate:function(){return!1},debug:function(){return x}}};return J}])}(window,window.angular);
//# sourceMappingURL=angular-watch-resource.min.map