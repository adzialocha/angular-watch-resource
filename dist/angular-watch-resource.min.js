/*! angular-watch-resource.js 03-04-2014 */

!function(a,b,c){"use strict";var d=b.module("ngWatchResource",[]);d.provider("ResourceConfiguration",[function(){var a={basePath:"",defaultData:{},defaultParams:{},defaultHeaders:{}},c={setBasePath:function(b){b&&"string"==typeof b&&(a.basePath=b)},setDefaultData:function(c){c&&b.isObject(c)&&(a.defaultData=c)},setDefaultParams:function(c){c&&b.isObject(c)&&(a.defaultParams=c)},setDefaultHeaders:function(c){c&&b.isObject(c)&&(a.defaultHeaders=c)},$get:function(){return{basePath:a.basePath,defaultData:a.defaultData,defaultParams:a.defaultParams,defaultHeaders:a.defaultHeaders}}};return c}]),d.factory("Resource",["$cacheFactory","$http","$q","$timeout","ResourceConfiguration",function(a,d,e,f,g){var h="id",i="id",j=[],k={},l=0,m=1,n=2,o=10,p=20,q=30,r=40,s={silent:!1,withCredentials:!1,responseType:"json",method:"GET",data:b.copy(g.defaultData),params:b.copy(g.defaultParams),headers:b.copy(g.defaultHeaders)},t={},u={};u.unique=function(a){return a.filter(function(a,b,c){return c.indexOf(a)===b})},u.hash=function(a){var b,c,d;if(b=0,d=a.length,0===d)return b;for(c=0;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;return b.toString()},u.update=function(a,c){var d=b.copy(a);return c&&b.forEach(Object.keys(c),function(a){a in d&&typeof d[a]==typeof c[a]&&(d[a]=b.isObject(d[a])?b.extend(d[a],c[a]):c[a])}),d},u.now=function(){var a=new Date;return a.getTime()},u.isEmpty=function(a){return a?b.isArray(a)?b.equals(j,a):b.equals(k,a):!0},u.pluck=function(a,c){var d=[];return b.forEach(a,function(a){c in a&&d.push(a[c])}),d},u.serialize=function(a){var c,d;return c=[],d="",b.forEach(Object.keys(a),function(d){a.hasOwnProperty(d)&&(b.isArray(a[d])?b.forEach(a[d],function(a){c.push(encodeURIComponent(d)+"[]="+a)}):c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d])))}),c.length>0&&(d="?"+c.join("&")),d};var v=function(b){t[b]={},this.name=b,this.storage=a(b)};v.prototype={exists:function(a){return b.isDefined(this.storage.get(a))},get:function(a){return this.storage.get(a)},set:function(a,b){return t[this.name][a]=b,this.storage.put(a,b)},update:function(a,b){var c=this.get(a);return c.$_updatedTimestamp=u.now(),c.data=b,this.storage.put(a,c)}};var w=new v("__resourceCache"),x=new v("__atomicCache"),y={};y.Resource={buildData:function(a,c){var d;return 0===c.length?!1:(a._data.type===m?d=x.get(c[0]).data:(d=[],b.forEach(c,function(a){d.push(x.get(a).data)})),w.update(a.cacheKey,d),!0)}},y.Atomic={_insertData:function(a,b){if(!(h in b))throw"CacheUtilsError: cant find ID key in object.";var c=(new A).build(a,b[h]);if(c.parseCacheKey(),!x.exists(c.cacheKey)){var d=new z(a,b[h]);x.set(c.cacheKey,d)}return x.update(c.cacheKey,b),c.cacheKey},cacheKeyArray:function(a,c){var d=[];return b.forEach(a,function(a){var b=(new A).build(c,a);d.push(b.parseCacheKey())}),d},findUncached:function(a,b){return a.filter(function(a){var c=(new A).build(b,a);return c.parseCacheKey(),!x.exists(c.cacheKey)})},populateCache:function(a,c,d){var e=this,f=[];return b.isArray(d)?b.forEach(d,function(a){f.push(e._insertData(c,a))}):f.push(this._insertData(c,d)),f}};var z=function(a,b){this._createdTimestamp=u.now(),this._updatedTimestamp=this._createdTimestamp,this._resourceName=a,this._resourceId=b,this.data=k},A=function(a,b,d){this._path=a||"",this._vars=b||{},this._data=d||{type:m},this.cacheKey=c,this.resourcePath=""};A.prototype.isCollection=function(){return this._data.type===n},A.prototype.build=function(a,b){return this._path=a+"/:id",this._vars[h]=b,this},A.prototype.parseCacheKey=function(){var a=this._path,c=this;if(a=a.replace(/\\:/g,":"),this._vars&&b.forEach(Object.keys(c._vars),function(b){a=a.replace(new RegExp(":"+b,"g"),c._vars[b])}),"/"!==a[0]&&(a="/"+a),this.resourcePath=a,this.isCollection()){var d=u.hash(this._data.collectionArray.join("."));a=a+"?"+this._data.collectionKey+"="+d}return this.cacheKey=a,this},A.prototype.serializeUrl=function(a,c){var d,e;if(d=a,this.isCollection()){var f={};if(this._data.collectionKey in a)throw"ResourcePointerError: collection key already exists as parameter";f[this._data.collectionKey]=c?c:this._data.collectionArray,d=b.extend(f,a)}e=u.serialize(d);var h=g.basePath;return"/"===h[h.length-1]&&(h=h.slice(0,h.length-1)),h+this.resourcePath+e};var B={};B.build=function(a,b){var c=a.serializeUrl(b.params),d={method:b.method,url:c,data:b.data,headers:b.headers,withCredentials:b.withCredentials,responseType:b.responseType,cache:!1};return d},B.optimize=function(a,b,c,d){var e={},f=!1,g=[];if(b._data.type===n){var i=y.Atomic.findUncached(b._data.collectionArray,d);e.url=b.serializeUrl(c.params,i);var j=b._data.collectionArray.filter(function(a){return-1===i.indexOf(a)});g=y.Atomic.cacheKeyArray(j,d),u.isEmpty(i)&&(f=!0)}else b._data.type===m?x.exists(b.cacheKey)&&(g=[b.cacheKey],f=!0):b._data.type===l&&w.get(b.cacheKey).isReady()&&(g=u.pluck(w.get(b.cacheKey).data,h),f=!0);var k=u.update(a,e);return{requestNotNeeded:f,cachedAtomicKeys:g,request:k}};var C=function(a,b,d){this.$__meta={pointer:a,options:d,errors:[],status:o},this.$_createdTimestamp=u.now(),this.$_updatedTimestamp=this.$_createdTimestamp,this.$_requestTimestamp=c,this.$_resourceName=b,this.$_url=a.serializeUrl(d.params),this.data=a._data.type===m?k:j};C.prototype={fetch:function(a,c,e){var f,g,h,i,j=this;if(f=this.$__meta.pointer,g=this.$__meta.options,i=B.build(f,g),!e){var k=B.optimize(i,f,g,this.$_resourceName);if(h=k.cachedAtomicKeys,y.Resource.buildData(f,h),k.requestNotNeeded)return this.$__meta.status=q,a&&b.isFunction(a)&&a(this),this;i=k.request}return this.$__meta.status=p,d(i).then(function(c){h=y.Atomic.populateCache(g,j.$_resourceName,c.data),y.Resource.buildData(f,h),j.$_requestTimestamp=u.now(),j.$__meta.status=q,a&&b.isFunction(a)&&a(j)},function(a){j.$__meta.status=r,j.$__meta.errors.push(a.data),a&&b.isFunction(a)&&a(j)}),this},isError:function(){return this.$__meta.status===r},isReady:function(){return this.$__meta.status===q},isEmpty:function(){return this.$__meta.status===q&&u.isEmpty(this.data)},message:function(a){var b=this.$__meta.errors;return 0===b.length?c:a?b:b[b.length-1]}};var D=function(a,b,c,d,e){var f,g,h;if(g=e,g.type===n&&(g.collectionArray=u.unique(g.collectionArray).sort()),f=new A(a,b,g).parseCacheKey(),w.exists(f.cacheKey))h=w.get(f.cacheKey);else{var i=u.update(s,d);h=new C(f,c,i),w.set(f.cacheKey,h),i.silent||h.fetch(!1)}return h},E=function(a,c){function d(c,d,f){var g;if(!a)throw"ResourceServiceError: path is missing";if(!b.isObject(e))throw"ResourceServiceError: path vars parameter must be an object";if(!c||"string"!=typeof c)throw"ResourceServiceError: resource name is missing or is not a string";if(g=d||{},!b.isObject(e))throw"ResourceServiceError: options parameter must be an object";return D(a,e,c,g,f)}var e=c||{};return{all:function(a,b){return d(a,b,{type:l})},one:function(a,b){return d(a,b,{type:m})},collection:function(a,c,e,f){var g;if(!c||!b.isArray(c))throw"ResourceServiceError: collection parameter must be an array and not undefined";return g=e||i,d(a,f,{type:n,collectionKey:g,collectionArray:c})},manipulate:function(){return!1},debug:function(){return t}}};return E}])}(window,window.angular);
//# sourceMappingURL=angular-watch-resource.min.map